# tell Tmux that outside terminal supports true color
set -g default-terminal 'tmux-256color'
set -ga terminal-overrides ',*:Tc'

# undercurl support
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

set -g mouse on
set -g allow-passthrough on
set -g set-clipboard external
bind -T root MouseUp2Pane paste

# prevent lagging <esc> in vim
set -s escape-time 0

# set prefix to C-e
set-option -g prefix C-c
bind C-c send-prefix
unbind C-b

# set color for status bar
set -g status-style bg=default,fg=white
set -g window-status-activity-style fg=default
set -g window-status-bell-style fg=default
set -g window-status-current-style fg=white,bold
set -g mode-style fg=black,bg=yellow

# set color for pane border
set -g pane-border-style fg=blue
set -g pane-active-border-style fg=magenta

set -g bell-action none
set -g focus-events on
set -g monitor-activity on
set -g visual-activity off
set -g visual-activity off
set -g -q mouse on
set -g status-interval 1
set -g automatic-rename on
set -g automatic-rename-format '#{?#{==:#{pane_current_path},#{HOME}},~,#{b:pane_current_path}}/'

# conceal status bar if only one window is opened
set -g status off
set -g status-position top
set -g status-justify "absolute-centre"
set -g status-left-length 40
set -g status-right-length 40
set -g status-right "%Y-%m-%d %H:%M"
set-hook -g client-session-changed "if -F '#{==:#{session_windows},1}' 'set status off' 'set status on'"
set-hook -g window-linked "if -F '#{==:#{session_windows},1}' 'set status off' 'set status on'"
set-hook -g window-unlinked "if -F '#{==:#{session_windows},1}' 'set status off' 'set status on'"

# move panes
bind S command-prompt -p "send pane to:" "join-pane -v -t '%%'"
bind J command-prompt -p "join pane from:" "join-pane -v -s '%%'"

# vim style key bindings
bind s   split-window -v -b -c "#{pane_current_path}"
bind v   split-window -h -c    "#{pane_current_path}"
bind n   new-window   -c       "#{pane_current_path}"
bind C-s split-window -v -b -c "#{pane_current_path}"
bind C-v split-window -h -c    "#{pane_current_path}"
bind C-n new-window   -c       "#{pane_current_path}"
bind x confirm-before kill-window
bind c confirm-before kill-pan
bind N new-session
bind BTab previous-window
bind Tab next-window
bind C-o kill-pane -a
bind o kill-pane -a
bind r rotate-window -D
bind R rotate-window -U
bind = select-layout tiled
bind C-r choose-buffer -Z

# use the vim motion keys to move between panes
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# use the vim motion keys to resize panes
bind -r C-h resize-pane -L 2
bind -r C-j resize-pane -D 2
bind -r C-k resize-pane -U 2
bind -r C-l resize-pane -R 2

# integration with vim/nvim (navigation)
# @is_vim is set from vim/nvim
# Source: https://github.com/christoomey/vim-tmux-navigator/issues/295#issuecomment-1123455337
bind -n M-h if-shell -F '#{@is_vim}' 'send-keys M-h' { if -F '#{pane_at_left}'   '' 'select-pane -L' }
bind -n M-j if-shell -F '#{@is_vim}' 'send-keys M-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind -n M-k if-shell -F '#{@is_vim}' 'send-keys M-k' { if -F '#{pane_at_top}'    '' 'select-pane -U' }
bind -n M-l if-shell -F '#{@is_vim}' 'send-keys M-l' { if -F '#{pane_at_right}'  '' 'select-pane -R' }
bind -T copy-mode-vi M-h if -F '#{pane_at_left}'   '' 'select-pane -L'
bind -T copy-mode-vi M-j if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind -T copy-mode-vi M-k if -F '#{pane_at_top}'    '' 'select-pane -U'
bind -T copy-mode-vi M-l if -F '#{pane_at_right}'  '' 'select-pane -R'

# use vim motion keys while in copy mode
set -g mode-keys vi
set -g status-keys emacs

# copy-mode with vim keys
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xclip -in -selection clipboard'
bind -T copy-mode-vi i send -X cancel
bind p paste-buffer -p
bind P command-prompt -p 'save history to file:' -I '~/tmux.history' 'capture-pane -S -32768 ; save-buffer %1 ; delete-buffer'

# replace current session with an existing session
bind-key X \
  confirm-before -p "attach another session and kill current session (#S)? (y/n)" \
  "if-shell \"(($(tmux display -p '#{session_many_attached}') > 0))\" \
    choose-session \
    \"run-shell \\\"tmux choose-session \\\\\\\"switch-client -t '%%'; kill-session -t '$(tmux display -p '#S')'\\\\\\\"\\\"\""

# vim:ft=tmux:ts=4:sts=4:sw=4:et:wrap:
